<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="microformat-editor.html">
<script src="bower_components/microformat-shiv/microformat-shiv.min.js"></script>

<dom-module id="micro-panel">
	<template strip-whitespace>
		<style>
			:host {
				--paper-toolbar-content: { padding: 0; };
			}
			.content-wrapper { overflow: hidden; height: 100%; height: calc(100vh - 64px); }
			neon-animatable, neon-animatable > * { width: 100%; height: 100%; border: 0; background: #fff; }
			paper-icon-button { margin-right: 0 !important; }
			paper-tabs { flex: 1 1 auto; height: 64px; }
			.ui-tab-content { overflow-y: scroll; -webkit-overflow-scrolling: touch; }
			.toolbar-wrapper { @apply(--layout-vertical); }
			.toolbar-wrapper .ui-tab-content { @apply(--layout-flex); }
			.editor-bottom-bar { --paper-toolbar-content: { justify-content: flex-end; }; }

			@media screen and (min-width: 450px) {
				#open-url-input, #auth-url-input { min-width: 70vw; }
			}

			@media screen and (max-width: 600px) {
				.content-wrapper { height: calc(100vh - 56px); }
				paper-tabs { height: 56px; }
				.editor-bottom-bar { padding-left: 10vw; padding-right: 10vw; }
			}

			@media screen and (min-width: 800px) {
				#open-url-input, #auth-url-input { min-width: 55vw; }
			}
		</style>

		<paper-header-panel>
			<paper-toolbar>
				<paper-menu-button id="menu-button"
						 open-animation-config='[{"name": "fade-in-animation", "timing": {"duration": 200}}]'
						close-animation-config='[{"name": "fade-out-animation", "timing": {"duration": 200}}]'>
					<paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
					<paper-menu class="dropdown-content">
						<paper-icon-item role="menuitem"><iron-icon icon="create" item-icon></iron-icon>New post</paper-icon-item>
						<paper-icon-item role="menuitem" on-tap="showOpenUrl"><iron-icon icon="input" item-icon></iron-icon>Open URL</paper-icon-item>
						<paper-icon-item role="menuitem" on-tap="showAbout"><iron-icon icon="info" item-icon></iron-icon>About...</paper-icon-item>
					</paper-menu>
				</paper-menu-button>
				<paper-tabs id="tabs" scrollable hide-scroll-buttons selected="{{selected}}">
					<paper-tab>Website</paper-tab>
					<paper-tab>Drafts</paper-tab>
					<template is="dom-repeat" items="{{editing}}">
						<paper-tab>Entry</paper-tab>
					</template>
				</paper-tabs>
			</paper-toolbar>

			<neon-animated-pages id="pages" entry-animation="fade-in-animation" exit-animation="fade-out-animation"
					selected="[[selected]]" class="content-wrapper content fit">
				<neon-animatable>
					<iframe id="frame" src="[[src]]"></iframe>
				</neon-animatable>
				<neon-animatable class="ui-tab-content">
					TODO
				</neon-animatable>
				<template is="dom-repeat" items="{{editing}}">
					<neon-animatable>
						<div class="toolbar-wrapper">
							<microformat-editor class="ui-tab-content" item="{{item}}"></microformat-editor>
							<paper-toolbar class="editor-bottom-bar">
								<paper-button on-tap="deleteEntry">Delete</paper-button>
								<paper-button on-tap="saveEntry">Save</paper-button>
							</paper-toolbar>
						</div>
					</neon-animatable>
				</template>
			</neon-animated-pages>
		</paper-header-panel>

		<paper-dialog id="auth-dialog" on-iron-overlay-closed="authDialogClosed"
				modal entry-animation="fade-in-animation" exit-animation="fade-out-animation">
			<h2>Sign in</h2>
			<p>
				<small>(manually adding <code>access_token</code> and <code>micropub_link</code> to <code>localStorage</code> in browser devtools also works)</small>
			</p>
			<paper-input id="auth-url-input" label="Your domain" type="url"></paper-input>
			<div class="buttons">
				<paper-button on-tap="authStart">Sign in</paper-button>
			</div>
		</paper-dialog>

		<paper-dialog id="open-url-dialog" on-iron-overlay-closed="openUrlClosed"
				modal entry-animation="fade-in-animation" exit-animation="fade-out-animation">
			<h2>Open URL</h2>
			<paper-input id="open-url-input" label="URL" type="url"></paper-input>
			<div class="buttons">
				<paper-button dialog-dismiss>Cancel</paper-button>
				<paper-button dialog-confirm>Go</paper-button>
			</div>
		</paper-dialog>

		<paper-dialog id="about-dialog" modal entry-animation="fade-in-animation" exit-animation="fade-out-animation">
			<h2>About</h2>
			<p>
				micro-panel is an admin panel for websites that support <a href="http://micropub.net/draft/">micropub</a> and <a href="http://microformats.org/wiki/microformats2">microformats2</a>.
			</p>
			<p>
				Check the <a href="https://github.com/myfreeweb/micro-panel">project's GitHub page</a> for updates, and <a href="https://val.packett.cool">the author's website</a> just because :)
			</p>
			<div class="buttons">
				<paper-button dialog-dismiss>Close</paper-button>
			</div>
		</paper-dialog>

	</template>

	<script>'use strict'
		Polymer({
			is: 'micro-panel',

			properties: {
				selected: { type: Number, value: 0 },
				src: { type: String, value: "/" },
				editing: { type: Array, value: [] }
			},

			attached: function () {
				if (!(localStorage.getItem('access_token') && localStorage.getItem('micropub_link'))) {
					if (location.search.match(/code=/))
						this.authFinish()
					else
						this.showAuthDialog()
				}
				this.$.frame.addEventListener('load', function (load) {
					console.log(load)
					var style = load.target.contentDocument.createElement('style')
					style.innerHTML += '.h-entry { border: 2px solid blue; }'
					style.innerHTML += '.h-entry::before { content: "Edit"; background: blue; color: white; padding: 6px; display: block; cursor: pointer; }'
					load.target.contentDocument.body.appendChild(style)
					load.target.contentDocument.addEventListener('click', this.editClick.bind(this))
				}.bind(this))
			},
			editClick: function (e) {
				if (!e.target.classList.contains('h-entry')) return
				var entry = Microformats.get({ node: e.target, textFormat: 'normalised' }).items[0]
				var i = 0
				if (this.editing.find(function (editingEntry) {
					i += 1
					return ((editingEntry.properties || {}).uid || [1])[0] == ((entry.properties || {}).uid || [1])[0]
				})) {
					this.selected = 1 + i
					return
				}
				var frameUrl = this.$.frame.contentWindow.location.href
				var url = ((entry.properties || {}).url || [frameUrl])[0]
				if (frameUrl == url)
					return this.editStart(entry)
				this.micropubGet('q=source&url=' + encodeURIComponent(url))
				.then(function (resp) { return resp.json() })
				.then(function (fullEntry) { this.editStart(fullEntry) }.bind(this))
				.catch(function (e) {
					console.log('Error when asking micropub for entry source', e)
					fetch(url)
					.then(function (resp) { return resp.text() })
					.then(function (body) {
						var fullEntry = Microformats.get({ html: body, textFormat: 'normalised', filter: ['h-entry'] }).items[0]
						this.editStart(fullEntry)
					}.bind(this))
					.catch(function (e) {
						console.log('Error when fetching entry', e)
						this.editStart(entry)
					}.bind(this))
				}.bind(this))
			},
			editStart: function (entry) {
				this.push('editing', entry)
				this.selected = 1 + this.editing.length
			},
			deleteEntry: function (e) {
				if (!confirm('Are you sure you want to delete the entry?')) return
				var entry = e.model.item
				var url = ((entry.properties || {}).url || [null])[0]
				if (!url) return alert('Somehow, an entry with no URL! I have no idea how to delete that.')
				this.micropubPost({ 'mp-action': 'delete', url: url })
				.then(function (resp) {
					if (resp.status >= 300) throw new Error("Couldn't delete the entry! Response: " + resp.status)
					this.stopEditing(entry)
				}.bind(this))
				.catch(function (e) {
					console.log('Error when deleting entry', e)
					alert(e)
				})
			},
			saveEntry: function (e) {
				if (!confirm('Are you sure you want to save the entry?')) return
				var entry = e.model.item
				var url = ((entry.properties || {}).url || [null])[0]
				if (!url) return alert('Somehow, an entry with no URL! I have no idea how to save that.')
				this.micropubPost({ 'mp-action': 'update', url: url, replace: { properties: entry.properties } })
				.then(function (resp) {
					if (resp.status >= 300) throw new Error("Couldn't save the entry! Response: " + resp.status)
					this.stopEditing(entry)
				}.bind(this))
				.catch(function (e) {
					console.log('Error when saving entry', e)
					alert(e)
				})
			},
			stopEditing: function (entry) {
				this.splice('editing', this.editing.indexOf(entry), 1)
				this.$.frame.src = this.$.frame.src // reload
				this.selected = 0
			},

			micropubGet: function (qs) {
				var link = localStorage.getItem('micropub_link')
				return fetch(link.indexOf('?') === -1 ? link + '?' + qs : link + '&' + qs, {
					headers: {
						Accept: 'application/json',
						Authorization: 'Bearer ' + localStorage.getItem('access_token')
					}
				})
			},
			micropubPost: function (obj) {
				return fetch(localStorage.getItem('micropub_link'), {
					method: 'post',
					headers: {
						Accept: 'application/json',
						'Content-Type': 'application/json',
						Authorization: 'Bearer ' + localStorage.getItem('access_token')
					},
					body: JSON.stringify(obj)
				})
			},

			showAuthDialog: function () {
				this.$['auth-url-input'].value = location.origin
				this.$['auth-dialog'].open()
			},
			authStart: function () {
				fetch(this.$['auth-url-input'].value)
				.then(function (resp) {
					var links = resp.headers.get('Link')
					var micropub_link = links.match(/<([^>]+)>;[^,]*rel="[^,]*micropub[^,]*"/)[1]
					var auth_link = links.match(/<([^>]+)>;[^,]*rel="[^,]*authorization_endpoint[^,]*"/)[1] || 'https://indieauth.com/auth'
					var token_link = links.match(/<([^>]+)>;[^,]*rel="[^,]*token_endpoint[^,]*"/)[1]
					var state = new Uint8Array(32)
					crypto.getRandomValues(state)
					state = state.join('')
					localStorage.setItem('micropub_link', micropub_link)
					localStorage.setItem('auth_link', auth_link)
					localStorage.setItem('token_link', token_link)
					localStorage.setItem('state', state)
					localStorage.setItem('redirect_uri', location.href)
					location.href = auth_link +
						'?me=' + encodeURIComponent(this.$['auth-url-input'].value) +
						'&client_id=' + encodeURIComponent(this.$['auth-url-input'].value) +
						'&redirect_uri=' + encodeURIComponent(location.href) +
						'&state=' + encodeURIComponent(state) +
						'&scope=post'
				}.bind(this))
			},
			authFinish: function () {
				var code = location.search.match(/code=([^&]+)/)[1]
				var me = location.search.match(/me=([^&]+)/)[1]
				fetch(localStorage.getItem('token_link'), {
					method: 'post',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8' },
					body: 'code=' + code + '&me=' + me + '&client_id=' + me +
						'&redirect_uri=' + encodeURIComponent(localStorage.getItem('redirect_uri')) +
						'&state=' + encodeURIComponent(localStorage.getItem('state')) + '&scope=post'
				}).then(function (resp) {
					console.log(resp)
					return resp.text()
				}).then(function (body) {
					var token = body.match(/access_token=([^&]+)/)[1]
					if (!token) throw new Error('No access token in response')
					localStorage.setItem('access_token', token)
					localStorage.removeItem('auth_link')
					localStorage.removeItem('token_link')
					localStorage.removeItem('state')
					localStorage.removeItem('redirect_uri')
					history.replaceState({}, '', location.href.replace(/\?[^#]*/, ''))
				}.bind(this)).catch(function (e) {
					console.log(e)
					// TODO: show error to user
					this.authStart()
				}.bind(this))
			},

			showOpenUrl: function () {
				this.$['menu-button'].close()
				this.$['open-url-input'].value = this.$.frame.contentWindow.location.href
				this.$['open-url-dialog'].open()
			},
			openUrlClosed: function (e) {
				if (!e.detail.confirmed) return
				this.src = this.$['open-url-input'].value
				this.selected = 0
			},

			showAbout: function () {
				this.$['menu-button'].close()
				this.$['about-dialog'].open()
			}

		})
	</script>
</dom-module>
